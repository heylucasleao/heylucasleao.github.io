---
{"dg-publish":true,"permalink":"/digital-garden/path-for-the-true-and-brave/text/10-efeitos-heterogeneos/"}
---

# Efeitos Heterogêneos

Nas análises anteriores, exploramos o ATE sob uma perspectiva populacional, que nos fornece uma medida agregada do impacto de uma intervenção. Embora essa abordagem seja fundamental para compreendermos o efeito geral, ela oculta as nuances de quem é, de fato, mais suscetível ao tratamento.

A realidade é que as pessoas respondem de forma distinta à mesma intervenção. Um medicamento pode ser eficaz para pacientes com certas características genéticas, mas ineficaz para outros. Uma estratégia de marketing pode converter um segmento demográfico específico enquanto desperdiça recursos em outro. Um programa educacional pode beneficiar estudantes com certos perfis socioeconômicos mais do que outros. Algoritmos de recomendação podem ter mais impacto a uma faixa etária que outra.

Para capturarmos esses **efeitos heterogêneos**, utilizamos o Efeito Médio de Tratamento Condicional (**CATE**). O objetivo é fundamentar decisões nas características específicas ($X$) de cada unidade, mudando a pergunta de _"O tratamento funciona?"_ para:

- _"Para quem o tratamento funciona melhor?"_
	
- _"Quais características predizem uma resposta positiva?"_

Identificar subgrupos com alta responsividade permite concentrar esforços onde o retorno é maior, otimizando o investimento e o tempo. 

Matematicamente, definimos o CATE como:

$$\tau(x) = \mathbb{E}[Y_i(1) - Y_i(0) \mid X_i = x]$$

Onde:

- $\tau(x)$ é o efeito condicional para indivíduos com características $x$
- $Y_i(1)$ e $Y_i(0)$ são os **resultados potenciais** com e sem tratamento
- $X_i$ representa o vetor de **características observáveis**

## Modelagem via Regressão Linear com Interação

Uma regressão linear simples ($\beta D$) estima apenas o efeito médio. Para flexibilizar o modelo e permitir heterogeneidade, introduzimostermos de interação entre a variável de tratamento ($D$) e as características ($X$).

A equação assume a forma:

$$y_i = \beta_0 + \underbrace{\beta_1 D_i}_{\text{Efeito Base}} + \beta_2 X_i + \underbrace{\beta_3 (D_i \times X_i)}_{\text{Interação}} + \epsilon_i$$

> [!tip] Intuição Geométrica
> 
> Sem interação, as retas de regressão para o grupo Tratado e Controle seriam paralelas (mesma inclinação). O termo de interação $\beta_3$ permite que as retas tenham inclinações diferentes. Se as retas não são paralelas, o efeito (a distância vertical entre elas) muda conforme $X$ muda.
### Derivação do Efeito Marginal

Para isolar o efeito do tratamento, derivamos a equação em relação a $D$:

$$\frac{\partial y_i}{\partial D_i} = \beta_1 + \beta_3 X_i$$

Isso demonstra matematicamente que o efeito não é mais constante ($\beta_1$): ele agora é uma função linear das características individuais ($\beta_1 + \beta_3 X_i$).

### Aproximação por Diferença Finitas

Na prática, como o modelo é linear, essa derivada pode ser calculada exatamente através da diferença entre duas predições. Usamos a definição de derivada onde o incremento ($\epsilon$) é igual a 1 unidade:

$$\frac{\delta y}{\delta D} \approx \hat{y}(D + 1) - \hat{y}(t)$$

Onde:

- $\hat{y}(D + 1)$ é a predição do modelo incrementando o tratamento original em uma unidade.
- $\hat{y}(D)$ é a predição do modelo com os dados originais.

### Exemplo ([Causal Inference in Python: Applying Causal Inference in the Tech Industry](https://github.com/matheusfacure/causal-inference-in-python-code/blob/main/causal-inference-in-python/06-Effect-Heterogeneity.ipynb)

```python

import statsmodels.formula.api as smf

# 1. Definição das covariáveis (características que podem causar heterogeneidade)
X = ["C(month)", "C(weekday)", "is_holiday", "competitors_price"]

# 2. Especificação do modelo com Interação # A sintaxe 'discounts * (X)'
# Isso permite que o efeito do desconto mude conforme o mês, feriado ou preço do concorrente.
regr_cate = smf.ols(f"sales ~ discounts*({'+'.join(X)})",
                    data=data).fit()

# 3. Estimativa do CATE (Efeito Médio de Tratamento Condicional) 
# Calculamos a diferença entre duas realidades hipotéticas para cada unidade: 
# Realidade A: O desconto atual + 1 unidade 
# Realidade B: O desconto atual 
# A diferença entre as predições isola o efeito marginal do desconto naquele contexto específico.
ols_cate_pred = (
    regr_cate.predict(data.assign(discounts=data["discounts"]+1)) 
    -regr_cate.predict(data)
)
```

## Avaliação

Diferentemente da previsão tradicional (onde comparamos $\hat{y}$ com $y$), na inferência causal nunca observamos o efeito real individual — o Problema Fundamental da Inferência Causal. Como, então, medir se o modelo de CATE é bom?

O objetivo de um modelo de heterogeneidade é justamente identificar quais unidades são mais responsivas ao tratamento que outras. Avaliamos a qualidade do modelo através da sua capacidade de ordenação - "_O quão bem identificamos essas unidades?_" - e calibração  - _"o quão precisas são essas estimativas?"_.

>[!tip] Exemplos
>Para os exemplos, deixarei o link com o código do Facure. https://github.com/matheusfacure/causal-inference-in-python-code/blob/main/causal-inference-in-python/06-Effect-Heterogeneity.ipynb.
### 1. Ordenação

A ideia é rankear a base ordenando pelo CATE de cada unidade. Podemos fazer isso por quantis ou por rankeamento simples. Nestes cenários, esperamos uma "escada" monotonicamente crescente: grupos com maior rank devem apresentar efeitos médios maiores. Nosso objetivo é separar unidades "boas" para o tratamento (altamente responsivas) de unidades "más" ou indiferentes.

### 2. Calibração

Há formas de observar a calibração. Uma mais simples, é avaliarmos se o ATE se aproxima das médias dos efeitos heterogêneos.
#### Curva de Efeito Cumulativo

Similar a modelos probabilísticos, verificamos via calibration plot: fazendo ordenação através do efeito médio acumulado. Ordenamos os dados do maior $\hat{\tau}$ para o menor e calculamos o efeito médio à medida que incluímos mais pessoas na amostra. O problema dessa abordagem é que o início da curva possui poucas amostras ($N$ pequeno), gerando alta variância e ruído (a "tremedeira" no começo do gráfico).
#### Curva de Ganho Cumulativo (Cumulative Gain)

Para corrigir o problema da variância, multiplicamos o efeito acumulado pela fração da população ($k/N$). Isso torna a curva análoga à curva ROC ou de Lorenz.

- **Eixo X:** Porcentagem da população tratada (ordenada pelo modelo).
    
- **Eixo Y:** Efeito acumulado "Total" (Ganho).
    
- **Linha de Base (Random):** Uma reta diagonal que liga $(0,0)$ ao ATE total, representando a escolha aleatória de indivíduos.

>[!note]
>**Critério de Escolha (AUUC):** O melhor modelo é aquele cuja curva "embarriga" mais para cima, distanciando-se da reta aleatória. Calculamos a Área Sob a Curva de Uplift (AUUC). Quanto maior a área, melhor o modelo consegue priorizar quem responde bem ao tratamento.

